
services:
  # Service Discovery
  eureka-server:
    build:
      context: ./eureka-server
    container_name: eureka-server
    ports:
      - "${EUREKA_PORT}:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    networks:
      - ctuconnect-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 1

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
    container_name: api-gateway
    ports:
      - "${API_GATEWAY_PORT}:8090"
    depends_on:
      eureka-server:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    networks:
      - ctuconnect-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8090/actuator/health" ]
      interval: 30s # C√≥ th·ªÉ tƒÉng l√™n 45s ho·∫∑c 60s
      timeout: 20s  # TƒÉng l√™n 20s (l·ªõn h∆°n 13.617s)
      retries: 5    # TƒÉng s·ªë l·∫ßn th·ª≠ l·∫°i ƒë·ªÉ linh ho·∫°t h∆°n

  # MongoDB for Post Service
  post_db:
    image: mongo:7.0
    container_name: mongodb
    ports:
      - "27018:27017"
    environment:
      - MONGO_INITDB_DATABASE=post_db
    volumes:
      - post-data:/data/db
    networks:
      - ctuconnect-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Neo4j Graph Database for User Service
  neo4j:
    image: neo4j:5.13.0
    container_name: neo4j-graph-db
    hostname: neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j-data:/data
      - ./database/neo4j/conf/neo4j.conf:/conf/neo4j.conf
      - ./database/neo4j/logs:/logs
      - ./database/neo4j/plugins:/plugins
      - ./database/neo4j/import:/import
      - ./database/neo4j/init.sh:/docker-entrypoint-initdb.d/init.sh
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_server_config_strict__validation_enabled=false
    networks:
      - ctuconnect-network
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7474" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s


 # Kafka for Event Streaming (No ZooKeeper needed)
  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka
    ports:
      - "9092:9092"   # M·ªü c·ªïng 9092 ra ngo√†i cho m√°y Host
      - "9093:9093"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093

      # üåü C·∫§U H√åNH QUAN TR·ªåNG:
      # INTERNAL: K·∫øt n·ªëi n·ªôi b·ªô Docker Compose
      # EXTERNAL: K·∫øt n·ªëi t·ª´ m√°y Host (localhost)
      KAFKA_LISTENERS: INTERNAL://:29092,EXTERNAL://:9092,CONTROLLER://:9093
      # üåü ADVERTISED: Kafka th√¥ng b√°o cho Client v·ªÅ ƒë·ªãa ch·ªâ k·∫øt n·ªëi
      # Client Host s·∫Ω k·∫øt n·ªëi t·ªõi localhost:9092
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://localhost:9092
      
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

      # Auto create topic
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      # Th√™m d√≤ng n√†y ƒë·ªÉ x·ª≠ l√Ω l·ªói UnsupportedVersionException (n·∫øu c√≤n)
      # KAFKA_INTER_BROKER_PROTOCOL_VERSION: "3.7" 

    volumes:
      - kafka-data:/var/lib/kafka/data
      
    # L·ªánh kh·ªüi t·∫°o v√† ch·∫°y (Quan tr·ªçng cho KRaft)
    command: 
      - /bin/sh
      - -c
      - "if [ ! -f /var/lib/kafka/data/meta.properties ]; then CLUSTER_ID=$$(/opt/kafka/bin/kafka-storage.sh random-uuid); /opt/kafka/bin/kafka-storage.sh format -t $$CLUSTER_ID -c /opt/kafka/config/kraft/server.properties; fi; /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/kraft/server.properties"
      
    networks:
      - ctuconnect-network

    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
      
  # Auth Database
  auth_db:
    image: postgres:15-alpine
    container_name: postgres_auth_db
    volumes:
      - auth_db_data:/var/lib/postgresql/data
      - ./database/auth_db:/docker-entrypoint-initdb.d
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=auth_db
      - POSTGRES_HOST_AUTH_METHOD=trust
    networks:
      - ctuconnect-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 1

  media_db:
    image: postgres:15-alpine
    container_name: media_db
    environment:
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        - POSTGRES_DB=media_db
    ports:
      - "5434:5432"
    volumes:
      - media_data:/var/lib/postgresql/data
    networks:
      - ctuconnect-network
    healthcheck:
        test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d media_db"]
        interval: 10s
        timeout: 5s
        retries: 1


  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - redis-data:/data
    networks:
      - ctuconnect-network
    command: redis-server --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 1


networks:
  ctuconnect-network:
    driver: bridge

volumes:
  auth_db_data:
  redis-data:
  neo4j-data:
  kafka-data:
  media_data:
  post-data:
