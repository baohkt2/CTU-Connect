
services:
  # Service Discovery
  eureka-server:
    build:
      context: ./eureka-server
    container_name: eureka-server
    ports:
      - "${EUREKA_PORT}:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    networks:
      - ctuconnect-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 1

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
    container_name: api-gateway
    ports:
      - "${API_GATEWAY_PORT}:8090"
    depends_on:
      eureka-server:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - ctuconnect-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8090/actuator/health" ]
      interval: 30s # CÃ³ thá»ƒ tÄƒng lÃªn 45s hoáº·c 60s
      timeout: 20s  # TÄƒng lÃªn 20s (lá»›n hÆ¡n 13.617s)
      retries: 5    # TÄƒng sá»‘ láº§n thá»­ láº¡i Ä‘á»ƒ linh hoáº¡t hÆ¡n

  # MongoDB for Post Service
  post_db:
    image: mongo:7.0
    container_name: mongodb
    ports:
      - "27018:27017"
    environment:
      - MONGO_INITDB_DATABASE=post_db
    volumes:
      - post-data:/data/db
    networks:
      - ctuconnect-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Neo4j Graph Database for User Service
  neo4j:
    image: neo4j:5.13.0
    container_name: neo4j-graph-db
    hostname: neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j-data:/data
      - ./database/neo4j/conf/neo4j.conf:/conf/neo4j.conf
      - ./database/neo4j/logs:/logs
      - ./database/neo4j/plugins:/plugins
      - ./database/neo4j/import:/import
      - ./database/neo4j/init.sh:/docker-entrypoint-initdb.d/init.sh
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_server_config_strict__validation_enabled=false
    networks:
      - ctuconnect-network
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7474" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s


 # Kafka for Event Streaming (No ZooKeeper needed)
  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka
    ports:
      - "9092:9092"   # Má»Ÿ cá»•ng 9092 ra ngoÃ i cho mÃ¡y Host
      - "9093:9093"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093

      # ðŸŒŸ Cáº¤U HÃŒNH QUAN TRá»ŒNG:
      # INTERNAL: Káº¿t ná»‘i ná»™i bá»™ Docker Compose
      # EXTERNAL: Káº¿t ná»‘i tá»« mÃ¡y Host (localhost)
      KAFKA_LISTENERS: INTERNAL://:29092,EXTERNAL://:9092,CONTROLLER://:9093
      # ðŸŒŸ ADVERTISED: Kafka thÃ´ng bÃ¡o cho Client vá» Ä‘á»‹a chá»‰ káº¿t ná»‘i
      # Client Host sáº½ káº¿t ná»‘i tá»›i localhost:9092
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://localhost:9092
      
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

      # Auto create topic
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      # ThÃªm dÃ²ng nÃ y Ä‘á»ƒ xá»­ lÃ½ lá»—i UnsupportedVersionException (náº¿u cÃ²n)
      # KAFKA_INTER_BROKER_PROTOCOL_VERSION: "3.7" 

    volumes:
      - kafka-data:/var/lib/kafka/data
      
    # Lá»‡nh khá»Ÿi táº¡o vÃ  cháº¡y (Quan trá»ng cho KRaft)
    command: 
      - /bin/sh
      - -c
      - "if [ ! -f /var/lib/kafka/data/meta.properties ]; then CLUSTER_ID=$$(/opt/kafka/bin/kafka-storage.sh random-uuid); /opt/kafka/bin/kafka-storage.sh format -t $$CLUSTER_ID -c /opt/kafka/config/kraft/server.properties; fi; /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/kraft/server.properties"
      
    networks:
      - ctuconnect-network

    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
      
  # Auth Database
  auth_db:
    image: postgres:15-alpine
    container_name: postgres_auth_db
    volumes:
      - auth_db_data:/var/lib/postgresql/data
      - ./database/auth_db:/docker-entrypoint-initdb.d
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=auth_db
      - POSTGRES_HOST_AUTH_METHOD=trust
    networks:
      - ctuconnect-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 1

  media_db:
    image: postgres:15-alpine
    container_name: media_db
    environment:
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        - POSTGRES_DB=media_db
    ports:
      - "5434:5432"
    volumes:
      - media_data:/var/lib/postgresql/data
    networks:
      - ctuconnect-network
    healthcheck:
        test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d media_db"]
        interval: 10s
        timeout: 5s
        retries: 1


  # Redis Cache (Global)
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - ctuconnect-network
    command: redis-server --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 1

  # ============================================================
  # RECOMMENDATION SERVICE - Database & AI Services
  # ============================================================
  
  # PostgreSQL Database for Recommendation Service
  recommend-postgres:
    image: postgres:15-alpine
    container_name: ctu-recommend-postgres
    environment:
      POSTGRES_DB: recommend_db
      POSTGRES_USER: recommend_user
      POSTGRES_PASSWORD: recommend_pass
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5435:5432"
    volumes:
      - recommend-postgres-data:/var/lib/postgresql/data
      - ./recommend-service/docker/init-db:/docker-entrypoint-initdb.d
    networks:
      - ctuconnect-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U recommend_user -d recommend_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache for Recommendation Service
  recommend-redis:
    image: redis:7-alpine
    container_name: ctu-recommend-redis
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes --requirepass recommend_redis_pass
    volumes:
      - recommend-redis-data:/data
    networks:
      - ctuconnect-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Python Inference Service (Development Mode with Volume Mount)
  recommend-python:
    image: python:3.10-slim
    container_name: ctu-recommend-python
    working_dir: /app
    command: >
      bash -c "
      apt-get update && apt-get install -y curl &&
      pip install --no-cache-dir -r requirements.txt &&
      uvicorn server:app --host 0.0.0.0 --port 8000 --reload
      "
    ports:
      - "8000:8000"
    environment:
      - MODEL_PATH=/app/model/academic_posts_model
      - LOG_LEVEL=INFO
      - WORKERS=1
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql://recommend_user:recommend_pass@recommend-postgres:5432/recommend_db
      - REDIS_URL=redis://:recommend_redis_pass@recommend-redis:6379/0
    volumes:
      # Mount entire python-model directory for live code reload
      - ./recommend-service/python-model:/app:cached
      # Exclude __pycache__ and other build artifacts
      - /app/__pycache__
      - /app/.pytest_cache
      - /app/venv
    networks:
      - ctuconnect-network
    depends_on:
      recommend-postgres:
        condition: service_healthy
      recommend-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 600s
    restart: unless-stopped
    stdin_open: true
    tty: true

  # Recommendation Service (Java Spring Boot)
  recommendation-service:
    build:
      context: ./recommend-service/java-api
    container_name: ctu-recommendation-service
    ports:
      - "8095:8095"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      recommend-postgres:
        condition: service_healthy
      recommend-redis:
        condition: service_healthy
      recommend-python:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - ctuconnect-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8095/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

networks:
  ctuconnect-network:
    driver: bridge

volumes:
  auth_db_data:
  redis-data:
  neo4j-data:
  kafka-data:
  media_data:
  post-data:
  recommend-postgres-data:
  recommend-redis-data:
